<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assistant Math√©matiques Cycle d'orientation - Coll√®ge</title>

<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }

body { background: #f9fafb; color: #111827; }
.chat-bg { background: #f9fafb; }
.card { background: #ffffff; border: 1px solid #e5e7eb; }
.user-msg { background: #000; color: #fff; }
.bot-msg { background: #fff; border: 1px solid #e5e7eb; }
.input-bar { background: #ffffff; border-top: 1px solid #e5e7eb; }

body.dark { background: #0f172a; color: #e5e7eb; }
body.dark .chat-bg { background: #0f172a; }
body.dark .card,
body.dark .bot-msg,
body.dark .input-bar {
  background: #020617;
  border-color: #1e293b;
  color: #e5e7eb;
}
body.dark input {
  background: #020617;
  color: #e5e7eb;
  border-color: #1e293b;
}

#chat-scroll {
  position: absolute;
  inset: 0 0 72px 0;
  overflow-y: auto;
  padding: 16px;
}

#input-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 72px;
  z-index: 100;
}

.katex { font-size: 1.1em; }
</style>
</head>

<body>
<header></header>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(function() {
        $("header").load("header.html");
      });
    </script>
	
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* Icons */
const SendIcon = () => (
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
<line x1="22" y1="2" x2="11" y2="13"></line>
<polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
</svg>
);

const CalculatorIcon = () => (
<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
<rect x="4" y="2" width="16" height="20" rx="2"></rect>
<line x1="8" y1="6" x2="16" y2="6"></line>
</svg>
);

const YoutubeIcon = () => (
<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
<path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814z"/>
<path d="M9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
</svg>
);

const MathText = ({ text }) => {
const ref = useRef(null);
useEffect(() => {
if (ref.current && window.renderMathInElement) {
renderMathInElement(ref.current, {
delimiters: [
{ left: "$$", right: "$$", display: true },
{ left: "$", right: "$", display: false }
],
throwOnError: false
});
}
}, [text]);
return <div ref={ref} className="whitespace-pre-line text-sm">{text}</div>;
};

// <-- MathContent minimal pour g√©rer image Pythagore uniquement -->
const MathContent = ({ content }) => {
  if (typeof content === 'string') return <MathText text={content}/>;
  return (
    <>
      {Object.entries(content).map(([key,val])=>{
        if(key==='image'){
          // R√©duire uniquement Pythagore
          if(val.src === 'pythagore.jpg'){
            return <img key={key} src={val.src} alt={val.alt} className="my-3 mx-auto rounded border w-1/2 h-auto"/>;
          }
          // Toutes les autres images restent normales
          return <img key={key} src={val.src} alt={val.alt} className="my-3 mx-auto rounded border max-w-full"/>;
        }
        return <div key={key} className="mb-3"><MathText text={val}/></div>;
      })}
    </>
  );
};

const App = () => {
const [messages, setMessages] = useState([
{ type: 'bot', text: "Bonjour ! üëã\nChoisis un th√®me ou un exercice." }
]);
const [input, setInput] = useState('');
const [mathData, setMathData] = useState(null);
const [lastExercise, setLastExercise] = useState(null);
const [dark, setDark] = useState(false);
const endRef = useRef(null);

useEffect(() => { document.body.classList.toggle('dark', dark); }, [dark]);
useEffect(() => { fetch('mathData3.json').then(r=>r.json()).then(setMathData); }, []);
useEffect(() => { endRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

if (!mathData) return null;

const generateExercise = (key) => {
const ex = mathData.themes[key].exercices;
return ex[Math.floor(Math.random()*ex.length)];
};

const analyze = (msg) => {
const m = msg.toLowerCase();
if (m === 'menu') {
return "üìö Th√®mes :\n\n" +
Object.values(mathData.themes).map((t,i)=>`${i+1}. ${t.nom}`).join('\n');
}
if (m.startsWith('cours')) {
const n = m.match(/cours (\d+)/);
if (n) {
const t = Object.values(mathData.themes)[n[1]-1];
return {
  title: t.nom,
  explanations: t.explanations
};
}
}
if (m.startsWith('exercice')) {
const n = m.match(/exercice (\d+)/);
if (n) {
const key = Object.keys(mathData.themes)[n[1]-1];
const t = mathData.themes[key];
const ex = generateExercise(key);
setLastExercise(ex);
return `‚úèÔ∏è Exercice (${t.nom})\n\n${ex.question}\n\nTape "solution"`;
}
}
if (m === 'solution' && lastExercise) {
return `‚úÖ ${lastExercise.reponse}`;
}
return "‚ùì";
};

const pushAction = (cmd) => {
const result = analyze(cmd);
if (result) {
setMessages(m => [...m, 
  { type: 'user', text: cmd }, 
  typeof result === 'string' ? { type:'bot', text: result } : { type:'bot', content: result }
]);
}
};

const send = () => {
if (!input.trim()) return;
pushAction(input);
setInput('');
};

return (
<>
<div id="chat-scroll" className="chat-bg">
<div className="max-w-4xl mx-auto">

<div className="card p-4 rounded-lg mb-3">
<h1 className="text-xl font-bold flex items-center gap-2">
<CalculatorIcon/> Maths Cycle d'orientation - coll√®ge
</h1>
</div>

<div className="flex flex-wrap gap-2 mb-2">
{Object.values(mathData.themes).map((t,i)=>(
<button key={i}
onClick={()=>pushAction(`cours ${i+1}`)}
className="px-3 py-1 bg-blue-600 text-white rounded-full text-xs">
Cours ‚Äì {t.nom}
</button>
))}
</div>

<div className="flex flex-wrap gap-2 mb-4">
{Object.values(mathData.themes).map((t,i)=>(
<button key={i}
onClick={()=>pushAction(`exercice ${i+1}`)}
className="px-3 py-1 bg-green-600 text-white rounded-full text-xs">
Exercice ‚Äì {t.nom}
</button>
))}
</div>

{messages.map((m,i)=>(
<div key={i} className={`flex mb-3 ${m.type==='user'?'justify-end':'justify-start'}`}>
<div className={`${m.type==='user'?'user-msg':'bot-msg'} px-4 py-3 rounded-lg max-w-md shadow`}>
{m.text && <MathText text={m.text}/>}
{m.content && <MathContent content={m.content.explanations || m.content}/>}
</div>
</div>
))}
<div ref={endRef}/>
</div>
</div>

<div id="input-bar" className="input-bar">
<div className="max-w-4xl mx-auto p-3 flex items-center gap-2">
<button onClick={()=>pushAction('menu')}
className="px-4 py-2 bg-purple-600 text-white rounded-full text-sm">
Menu
</button>

<button
onClick={()=>{ if (lastExercise) pushAction('solution'); }}
className="px-4 py-2 bg-yellow-400 text-black rounded-full text-sm font-semibold">
Solution
</button>

<button onClick={()=>window.open('https://www.youtube.com/@lesmaths1200','_blank')}
className="px-4 py-2 bg-red-600 text-white rounded-full text-sm">
YouTube
</button>

<button onClick={()=>setDark(d=>!d)}
className="px-3 py-2 rounded-full text-sm border">
{dark?'‚òÄÔ∏è':'üåô'}
</button>

<input value={input}
onChange={e=>setInput(e.target.value)}
onKeyDown={e=>e.key==='Enter' && send()}
placeholder="Pose ta question‚Ä¶"
className="flex-1 border rounded-lg px-3 py-2 text-sm"/>

<button onClick={send} className="bg-black text-white px-4 py-2 rounded-lg">
<SendIcon/>
</button>
</div>
</div>
</>
);
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>