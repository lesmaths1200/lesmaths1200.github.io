<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assistant Math√©matiques Cycle d'orientation - Coll√®ge</title>

<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; font-family: system-ui, sans-serif; }

body { background: #f9fafb; color: #111827; }
.chat-bg { background: #f9fafb; }
.card { background: #ffffff; border: 1px solid #e5e7eb; }
.user-msg { background: #000; color: #fff; }
.bot-msg { background: #fff; border: 1px solid #e5e7eb; }
.input-bar { background: #ffffff; border-top: 1px solid #e5e7eb; }

body.dark { background: #0f172a; color: #e5e7eb; }
body.dark .chat-bg,
body.dark .card,
body.dark .bot-msg,
body.dark .input-bar {
  background: #020617;
  border-color: #1e293b;
  color: #e5e7eb;
}

#chat-scroll {
  position: absolute;
  inset: 0 0 72px 0;
  overflow-y: auto;
  padding: 16px;
}

#input-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 72px;
}

.katex { font-size: 1.1em; }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* Ic√¥nes */
const CalculatorIcon = () => (
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <rect x="4" y="2" width="16" height="20" rx="2"></rect>
    <line x1="8" y1="6" x2="16" y2="6"></line>
  </svg>
);

const MathText = ({ text }) => {
  const ref = useRef(null);

  useEffect(() => {
    if (ref.current && window.renderMathInElement) {
      renderMathInElement(ref.current, {
        delimiters: [
          { left: "$$", right: "$$", display: true },
          { left: "$", right: "$", display: false }
        ],
        throwOnError: false
      });
    }
  }, [text]);

  return <div ref={ref} className="whitespace-pre-line text-sm">{text}</div>;
};

const App = () => {
  const [messages, setMessages] = useState([
    { type: 'bot', text: "Bonjour üëã\nChoisis un cours ou un exercice." }
  ]);
  const [input, setInput] = useState('');
  const [mathData, setMathData] = useState(null);
  const [lastExercise, setLastExercise] = useState(null);
  const [dark, setDark] = useState(false);
  const endRef = useRef(null);

  useEffect(() => { document.body.classList.toggle('dark', dark); }, [dark]);
  useEffect(() => {
    fetch('mathData3.json').then(r => r.json()).then(setMathData);
  }, []);
  useEffect(() => { endRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

  if (!mathData) return null;

  const analyze = (msg) => {
    const m = msg.toLowerCase();

    if (m === 'menu') {
      return "üìö Th√®mes :\n\n" +
        Object.values(mathData.themes).map((t,i)=>`${i+1}. ${t.nom}`).join('\n');
    }

    if (m.startsWith('cours')) {
      const n = m.match(/cours (\d+)/);
      if (n) {
        const t = Object.values(mathData.themes)[n[1]-1];
        return {
          title: t.nom,
          explanations: t.explanations
        };
      }
    }

    if (m.startsWith('exercice')) {
      const n = m.match(/exercice (\d+)/);
      if (n) {
        const key = Object.keys(mathData.themes)[n[1]-1];
        const ex = mathData.themes[key].exercices[
          Math.floor(Math.random()*mathData.themes[key].exercices.length)
        ];
        setLastExercise(ex);
        return `‚úèÔ∏è Exercice\n\n${ex.question}\n\nTape "solution"`;
      }
    }

    if (m === 'solution' && lastExercise) {
      return `‚úÖ ${lastExercise.reponse}`;
    }

    return "‚ùì";
  };

  const pushAction = (cmd) => {
    const result = analyze(cmd);
    if (!result) return;

    setMessages(m => [
      ...m,
      { type: 'user', text: cmd },
      typeof result === 'string'
        ? { type: 'bot', text: result }
        : { type: 'bot', content: result }
    ]);
  };

  return (
    <>
      <div id="chat-scroll" className="chat-bg">
        <div className="max-w-4xl mx-auto">

          <div className="card p-4 rounded-lg mb-3">
            <h1 className="text-xl font-bold flex items-center gap-2">
              <CalculatorIcon /> Maths ‚Äì Cycle d'orientation
            </h1>
          </div>

          <div className="flex flex-wrap gap-2 mb-4">
            {Object.values(mathData.themes).map((t,i)=>(
              <button key={i}
                onClick={()=>pushAction(`cours ${i+1}`)}
                className="px-3 py-1 bg-blue-600 text-white rounded-full text-xs">
                Cours ‚Äì {t.nom}
              </button>
            ))}
          </div>

          {messages.map((m,i)=>(
            <div key={i} className={`flex mb-3 ${m.type==='user'?'justify-end':'justify-start'}`}>
              <div className={`${m.type==='user'?'user-msg':'bot-msg'} px-4 py-3 rounded-lg max-w-md shadow`}>

                {m.text && <MathText text={m.text}/>}

                {m.content && (
                  <>
                    <h2 className="font-bold mb-2">üìñ {m.content.title}</h2>

                    {Object.entries(m.content.explanations).map(([key,val])=>{
                      if (key === 'image') {
                        return (
                          <img key={key}
                            src={val.src}
                            alt={val.alt}
                            className="my-3 mx-auto rounded border max-w-full"
                          />
                        );
                      }
                      return (
                        <div key={key} className="mb-3">
                          <MathText text={val}/>
                        </div>
                      );
                    })}
                  </>
                )}

              </div>
            </div>
          ))}

          <div ref={endRef}/>
        </div>
      </div>

      <div id="input-bar" className="input-bar">
        <div className="max-w-4xl mx-auto p-3 flex gap-2">
          <input
            value={input}
            onChange={e=>setInput(e.target.value)}
            onKeyDown={e=>e.key==='Enter' && pushAction(input)}
            placeholder="Commande : cours 1, exercice 1, solution‚Ä¶"
            className="flex-1 border rounded-lg px-3 py-2 text-sm"
          />
          <button onClick={()=>pushAction(input)}
            className="bg-black text-white px-4 py-2 rounded-lg">
            Envoyer
          </button>
          <button onClick={()=>setDark(d=>!d)}
            className="px-3 py-2 rounded-lg border">
            {dark ? '‚òÄÔ∏è' : 'üåô'}
          </button>
        </div>
      </div>
    </>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
